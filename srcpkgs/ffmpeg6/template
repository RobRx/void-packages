# Template file for 'ffmpeg6'
# audacity also needs to be bumped when a new ffmpeg version bumps libavformat's soname!
pkgname=ffmpeg6
version=6.1.2
revision=2
hostmakedepends="pkg-config perl"
makedepends="zlib-devel bzip2-devel freetype-devel $(vopt_if alsa alsa-lib-devel)
 $(vopt_if x11 'libxcb-devel libXfixes-devel libXext-devel libXvMC-devel') lame-devel
 x264-devel $(vopt_if jack jack-devel) SDL2-devel libcdio-paranoia-devel gnutls-devel
 harfbuzz-devel libass-devel libbluray-devel opus-devel ocl-icd-devel libbs2b-devel
 libvidstab-devel vmaf-devel libplacebo-devel $(vopt_if pulseaudio pulseaudio-devel)
 $(vopt_if vaapi libva-devel) $(vopt_if vdpau libvdpau-devel) $(vopt_if x265 x265-devel)
 v4l-utils-devel libvpx-devel libaom-devel $(vopt_if sndio sndio-devel) libdav1d-devel
 zimg-devel fontconfig-devel libglvnd-devel $(vopt_if webp libwebp-devel) $(vopt_if drm libdrm-devel)
 $(vopt_if vulkan 'vulkan-loader Vulkan-Headers') $(vopt_if nvcodec nv-codec-headers)"
depends="ffplay6>=${version}_${revision}"
short_desc="Decoding, encoding and streaming software"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-3.0-or-later"
homepage="https://www.ffmpeg.org"
changelog="https://raw.githubusercontent.com/FFmpeg/FFmpeg/master/Changelog"
distfiles="https://www.ffmpeg.org/releases/ffmpeg-${version}.tar.xz"
checksum=3b624649725ecdc565c903ca6643d41f33bd49239922e45c9b1442c63dca4e38

build_options="alsa x265 vaapi vdpau nvcodec sndio pulseaudio jack webp vulkan drm x11"
build_options_default="alsa x265 pulseaudio vulkan drm x11"
desc_option_webp="Enable support for WebP"

case "$XBPS_TARGET_MACHINE" in
	i686*)
		build_options_default+=" vaapi vdpau nvcodec"
		hostmakedepends+=" nasm"
		;;
	x86_64*)
		hostmakedepends+=" nasm"
		build_options_default+=" vaapi vdpau nvcodec onevpl"
		;;
	ppc64*) build_options_default+=" vaapi vdpau";;
	mips*) CFLAGS="-mnan=legacy";;
esac

_apply_patch() {
	local args="$1" pname="$(basename $2)"

	if [ ! -f ".${pname}_done" ]; then
		patch -N $args -i $2
		touch .${pname}_done
	fi
}

post_patch() {
	case "$XBPS_TARGET_MACHINE" in
		ppc64le*) ;;
		ppc*) _apply_patch -p1 ${FILESDIR}/altivec.patch ;;
	esac
}

do_configure() {
	# Fix gcc on x86_64-musl only
	if [ "$XBPS_TARGET_MACHINE" = "x86_64-musl" ]; then
		vsed -i configure -e "s;_cflags_speed='-O3';_cflags_speed='-O2';"
	fi

	if [ "$CROSS_BUILD" ]; then
		case "$XBPS_TARGET_MACHINE" in
			arm*) _arch="arm";;
			aarch64*) _arch="aarch64";;
			mips*) _arch="mips";;
			ppc64*) _arch="ppc64";;
			ppc*) _arch="ppc";;
			*) _arch="${XBPS_TARGET_MACHINE%%-musl}";;
		esac

		_args+=" --enable-cross-compile
			--sysroot=$XBPS_CROSS_BASE
			--cross-prefix=${XBPS_CROSS_TRIPLET}-
			--target-os=linux --arch=${_arch}"
	fi

	case "$XBPS_TARGET_MACHINE" in
		ppc|ppc-musl) _args+=" --disable-altivec";;
	esac

	./configure --prefix=/usr \
		--disable-debug \
		--disable-iconv \
		--disable-stripping \
		$(vopt_enable alsa) \
		--enable-gnutls \
		--enable-gpl \
		--enable-libaom \
		--enable-libass \
		--enable-libbluray \
		--enable-libbs2b \
		--enable-libcdio \
		--enable-libdav1d \
		$(vopt_enable drm libdrm) \
		--enable-libfontconfig \
		--enable-libfreetype \
		--enable-libharfbuzz \
		$(vopt_enable jack libjack) \
		--enable-libmp3lame \
		--enable-libopus \
		--enable-libplacebo \
		$(vopt_enable pulseaudio libpulse) \
		--enable-libv4l2 \
		--enable-libvidstab \
		--enable-libvmaf \
		--enable-libvpx \
		$(vopt_enable webp libwebp) \
		--enable-libx264 \
		$(vopt_enable x265 libx265) \
		$(vopt_enable x11 libxcb) \
		$(vopt_enable x11 libxcb-shm) \
		$(vopt_enable x11 libxcb-xfixes) \
		$(vopt_enable x11 libxcb-shape) \
		--enable-libzimg \
		--enable-opencl \
		--enable-opengl \
		$(vopt_enable sndio) \
		--enable-shared \
		--enable-static \
		--enable-version3 \
		$(vopt_enable vaapi) \
		$(vopt_enable vdpau) \
		$(vopt_enable nvcodec nvenc) \
		$(vopt_enable nvcodec nvdec) \
		$(vopt_enable vulkan) \
		$(vopt_enable x11 xlib) \
		--enable-lto \
		${_args}
}

do_build() {
	make ${makejobs}
	make doc/ff{mpeg,play}.1
}

do_install() {
	make DESTDIR=${DESTDIR} install install-man
}

libavcodec6_package() {
	short_desc="FFmpeg codec library"
	pkg_install() {
		vmove "usr/lib/libavcodec.so.*"
	}
}

libavdevice6_package() {
	short_desc="FFmpeg device handling library"
	pkg_install() {
		vmove "usr/lib/libavdevice.so.*"
	}
}

libavresample6_package() {
	short_desc="Package deprecated, removal needed"
	build_style=meta
}

libavformat6_package() {
	short_desc="FFmpeg file format library"
	pkg_install() {
		vmove "usr/lib/libavformat.so.*"
	}
}

libavutil6_package() {
	short_desc="FFmpeg utility library"
	pkg_install() {
		vmove "usr/lib/libavutil.so.*"
	}
}

libavfilter6_package() {
	short_desc="FFmpeg audio/video filter library"
	pkg_install() {
		vmove "usr/lib/libavfilter.so.*"
	}
}

libpostproc6_package() {
	short_desc="FFmpeg video postprocessing library"
	pkg_install() {
		vmove "usr/lib/libpostproc.so.*"
	}
}

libswscale6_package() {
	short_desc="FFmpeg video scaling library"
	pkg_install() {
		vmove "usr/lib/libswscale.so.*"
	}
}

libswresample6_package() {
	short_desc="FFmpeg video resampling library"
	pkg_install() {
		vmove "usr/lib/libswresample.so.*"
	}
}

ffmpeg6-devel_package() {
	depends="
		libavcodec6>=${version}_${revision}
		libavdevice6>=${version}_${revision}
		libavformat6>=${version}_${revision}
		libavutil6>=${version}_${revision}
		libavfilter6>=${version}_${revision}
		libpostproc6>=${version}_${revision}
		libswscale6>=${version}_${revision}
		libswresample6>=${version}_${revision}"
	short_desc+=" - development files"
	conflicts="ffmpeg-devel"
	replaces="ffmpeg-devel>=0"
	case "$XBPS_TARGET_MACHINE" in
		i686*)
		# /usr/bin/strip: error: the input file '/destdir//ffmpeg-devel-4.4.4/usr/lib/libavfilter.a(vf_atadenoise.o)' has no sections
		nostrip_files="/usr/lib/libavfilter.a";;
	esac
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
		vmove usr/share/ffmpeg/examples
		vmove usr/share/man/man3
	}
}

ffplay6_package() {
	short_desc="Simple video player using FFmpeg and SDL2"
	pkg_install() {
		vmove usr/bin/ffplay
		vmove "usr/share/man/man1/ffplay*"
	}
}
